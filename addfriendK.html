<!DOCTYPE html>
<html lang="zh-TW">
<head>
  <meta charset="UTF-8">
  <title>Redirecting...</title>
  <script src="https://static.line-scdn.net/liff/edge/2/sdk.js"></script>
  <meta name="viewport" content="width=device-width, initial-scale=1">

  <!-- Open Graph é è¦½ -->
  <meta property="og:title" content="åŠ å…¥å¥½å‹">
  <meta property="og:description" content="è«‹ç™»å…¥å¾Œè‡ªå‹•åŠ å…¥å¥½å‹">
  <meta property="og:url" content="https://lineliff.jowua-life.com/addfriendK.html"> <!-- ç¢ºä¿é€™è£¡æ›´æ–°ç‚ºä½ çš„æ–°ç¶²åŸŸ -->
  <meta property="og:type" content="website">
  <meta property="og:image" content="https://lineliff.jowua-life.com/ä½ çš„é è¦½åœ–.jpg"> <!-- è«‹æ›¿æ›ç‚ºä½ çš„å¯¦éš›é è¦½åœ–ç¶²å€ -->

  <!-- Meta Pixel æˆ– GA4 æˆ– LINE Tag ç¨‹å¼ç¢¼ å°‡è²¼åœ¨é€™è£¡ (å¦‚æœæœ‰çš„è©±) -->

  <style>
    body {
      font-family: 'Inter', sans-serif; /* ä½¿ç”¨ Inter å­—é«” */
      display: flex;
      justify-content: center;
      align-items: center;
      min-height: 100vh;
      margin: 0;
      background-color: #f0f2f5; /* è¼•å¾®çš„èƒŒæ™¯è‰² */
      padding: 20px; /* å¢åŠ ä¸€äº›å…§é‚Šè· */
      box-sizing: border-box; /* ç¢ºä¿å…§é‚Šè·ä¸æ’é–‹ä½ˆå±€ */
    }
    .loading-container {
      background-color: #fff;
      padding: 30px;
      border-radius: 12px; /* åœ“è§’ */
      box-shadow: 0 4px 15px rgba(0, 0, 0, 0.1); /* æŸ”å’Œçš„é™°å½± */
      text-align: center;
      max-width: 400px; /* æœ€å¤§å¯¬åº¦ */
      width: 100%;
      box-sizing: border-box;
    }
    .loading-container p {
      margin-bottom: 20px;
      font-size: 1.1em;
      color: #333;
      line-height: 1.6;
    }
    .loading-container a {
      display: inline-block;
      padding: 12px 25px;
      background-color: #06C755; /* LINE ç¶ è‰² */
      color: white;
      border-radius: 8px; /* åœ“è§’æŒ‰éˆ• */
      text-decoration: none;
      font-size: 1.05em;
      font-weight: bold;
      transition: background-color 0.3s ease; /* å¹³æ»‘éæ¸¡æ•ˆæœ */
      box-shadow: 0 2px 5px rgba(0, 0, 0, 0.2); /* æŒ‰éˆ•é™°å½± */
    }
    .loading-container a:hover {
      background-color: #05a84a; /* é¼ æ¨™æ‡¸åœæ™‚é¡è‰²è®Šæ·± */
    }
    .qr-code-container {
      margin-top: 20px;
      display: flex;
      flex-direction: column;
      align-items: center;
      justify-content: center;
    }
    .qr-code-container #qrcode {
      padding: 10px; /* çµ¦ QR Code ä¸€é»é‚Šè· */
      background-color: #fff;
      border-radius: 8px;
      box-shadow: 0 2px 8px rgba(0, 0, 0, 0.1);
      width: 180px; /* å›ºå®šå¯¬åº¦ï¼Œå¯èª¿æ•´ */
      height: 180px; /* å›ºå®šé«˜åº¦ï¼Œå¯èª¿æ•´ */
      display: flex; /* ç¢ºä¿å…§å®¹å±…ä¸­ */
      align-items: center;
      justify-content: center;
    }
    .qr-code-container p.scan-text {
      margin-top: 15px;
      font-size: 1.1em;
      color: #555;
    }
  </style>
  <!-- å¼•å…¥ QR Code ç”¢ç”Ÿå‡½å¼åº« -->
  <script src="https://cdn.jsdelivr.net/npm/qrcode@1.5.1/build/qrcode.min.js"></script>
</head>
<body>
  <div class="loading-container">
    <p>è¼‰å…¥ä¸­...</p>
  </div>

  <script>
    // LINE å®˜æ–¹å¸³è™ŸèŠå¤©å®¤é€£çµï¼Œç”¨æ–¼ QR Code
    const lineOfficialAccountUrl = "https://line.me/R/ti/p/@653dssrk";

    async function main() {
      try {
        await liff.init({ liffId: "2003553378-dwar3Na2" }); // è«‹æ›¿æ›ç‚ºä½ çš„ LIFF ID
        await liff.ready;

        // **NEW LOGIC: Prioritize LINE Login first**
        // If not logged in, initiate login process.
        // On external browsers, this will redirect to LINE Login page.
        // On subsequent return (after login), liff.isLoggedIn() will be true.
        if (!liff.isLoggedIn()) {
          liff.login(); // This will cause a redirect if not logged in
          return; // Stop execution here, as page will reload after login or redirect
        }

        // *** Code below this line will ONLY execute if liff.isLoggedIn() is TRUE ***

        // ****** åˆ¤æ–·æ˜¯å¦åœ¨ LINE App å…§é–‹å•Ÿ (ç”¨æ–¼å·²ç™»å…¥ä½†ä»åœ¨å¤–éƒ¨ç€è¦½å™¨çš„æƒ…æ³) ******
        if (!liff.isInClient()) {
          // å¦‚æœä¸åœ¨ LINE App å…§ (æ­¤æ™‚å·²ç™»å…¥)ï¼Œé€²ä¸€æ­¥åˆ¤æ–·æ˜¯å¦ç‚ºé›»è…¦ç‰ˆæˆ–æ‰‹æ©Ÿå¤–éƒ¨ç€è¦½å™¨
          if (liff.getOS() === 'web') {
            // é›»è…¦ç‰ˆ (å·²ç™»å…¥ä½†ä»åœ¨å¤–éƒ¨ç€è¦½å™¨)ï¼šé¡¯ç¤º QR Code
            document.querySelector('.loading-container').innerHTML = `
              <p>æ‚¨å·²æˆåŠŸç™»å…¥ï¼è«‹ä½¿ç”¨ LINE æ‡‰ç”¨ç¨‹å¼æƒæä¸‹æ–¹ QR Codeï¼Œä»¥é–‹å•Ÿå°è©±ã€‚</p>
              <div class="qr-code-container">
                <canvas id="qrcode"></canvas>
                <p class="scan-text">è«‹æƒæä»¥é–‹å•Ÿå°è©±</p>
              </div>
              <p style="margin-top:20px; font-size:14px; color:#666;">ï¼ˆå¦‚æœæƒæå¾Œç„¡æ³•é–‹å•Ÿï¼Œè«‹ç›´æ¥è¤‡è£½é€£çµåˆ° LINE èŠå¤©å®¤ä¸­å‚³é€ä¸¦é»æ“Šï¼‰</p>
            `;
            // ç”¢ç”Ÿ QR Code
            QRCode.toCanvas(document.getElementById('qrcode'), lineOfficialAccountUrl, {
                width: 160,
                margin: 2,
                color: {
                    dark: '#5AC363',
                    light: '#ffffff'
                }
            }, function (error) {
                if (error) console.error(error);
                console.log('QR Code generated!');
            });

          } else {
            // æ‰‹æ©Ÿç‰ˆ (å·²ç™»å…¥ä½†ä»åœ¨å¤–éƒ¨ç€è¦½å™¨)ï¼šé¡¯ç¤ºæç¤ºè¨Šæ¯ä¸¦æä¾›é€£çµè®“ä½¿ç”¨è€…é»æ“Š
            // é€™å€‹æŒ‰éˆ•æ‡‰è©²é‚„æ˜¯å–šé†’ LIFF é€£çµï¼Œå¼·åˆ¶åœ¨ LIFF å…§éƒ¨æ‰“é–‹
            document.querySelector('.loading-container').innerHTML = `
              <p>æ‚¨å·²æˆåŠŸç™»å…¥ï¼è«‹é»æ“ŠæŒ‰éˆ•åœ¨ LINE æ‡‰ç”¨ç¨‹å¼ä¸­é–‹å•Ÿï¼Œä»¥ç²å¾—å®Œæ•´é«”é©—ã€‚</p>
              <a href="https://liff.line.me/${liff.getContext().liffId}" target="_blank" style="display:inline-block; padding: 10px 20px; background-color: #06C755; color: white; border-radius: 5px; text-decoration: none; margin-top: 20px;">
                åœ¨ LINE æ‡‰ç”¨ç¨‹å¼ä¸­é–‹å•Ÿ
              </a>
              <p style="margin-top:15px; font-size:14px; color:#666;">ï¼ˆå¦‚æœé»æ“Šå¾Œç„¡æ³•é–‹å•Ÿï¼Œè«‹ç›´æ¥è¤‡è£½é€£çµåˆ° LINE èŠå¤©å®¤ä¸­å‚³é€ä¸¦é»æ“Šï¼‰</p>
            `;
          }
          return; // Stop execution here, as the user needs to interact to proceed
        }

        // *** Code below this line will ONLY execute if liff.isLoggedIn() is TRUE AND liff.isInClient() is TRUE ***

        const profile = await liff.getProfile();
        const uid = profile.userId;
        const nickname = profile.displayName;
        const email = liff.getDecodedIDToken()?.email || "";

        console.log("âœ… Line UID:", uid);
        console.log("âœ… Display Name:", nickname);
        console.log("âœ… Email:", email);

        // å‚³ webhook
        await fetch("https://hook.us1.make.com/yci84no2zw89i23hdj8rils9utasegfk", { // è«‹æ›¿æ›ç‚ºä½ çš„ Make Webhook URL
          method: "POST",
          headers: { "Content-Type": "application/json" },
          body: JSON.stringify({ uid, nickname, email })
        });

        // å˜—è©¦åŠ å¥½å‹è·³è½‰ (åœ¨ LINE App å…§åŸ·è¡Œ)
        try {
          await liff.openWindow({ url: lineOfficialAccountUrl, external: false });
        } catch (err) {
          console.error("âŒ openWindow failed:", err);
          // å¦‚æœ liff.openWindow å¤±æ•—ï¼Œä»ç„¶é¡¯ç¤ºè¨Šæ¯æˆ–å°å¼•
          document.querySelector('.loading-container').innerHTML = "<p>å·²æˆåŠŸå–å¾—æ‚¨çš„è³‡æ–™ä¸¦ç™¼é€ã€‚è‹¥è‡ªå‹•è·³è½‰å¤±æ•—ï¼Œè«‹é»æ“Šä»¥ä¸‹é€£çµï¼š</p><a href='" + lineOfficialAccountUrl + "' target='_blank'>å‰å¾€ LINE å®˜æ–¹å¸³è™Ÿ</a>";
        }

      } catch (e) {
        document.querySelector('.loading-container').innerHTML = "<p>ğŸš¨ ç™¼ç”ŸéŒ¯èª¤ï¼š" + e.message + "</p>";
        console.error("âŒ éŒ¯èª¤ç™¼ç”Ÿï¼š", e);
      }
    }

    main();
  </script>
</body>
</html>
